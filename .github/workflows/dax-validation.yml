name: DAX Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'dax_patterns/**'
      - 'tests/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'dax_patterns/**'
      - 'tests/**'

jobs:
  validate:
    name: Validate DAX Formulas
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Validate DAX files
      run: |
        echo "ðŸ” Running DAX validation..."
        python3 tests/validate_dax.py dax_patterns/ -v
        
    - name: Count measures
      run: |
        echo "ðŸ“Š Counting DAX measures..."
        total_measures=$(grep -r "^[A-Za-z0-9_][A-Za-z0-9_ %-]* = $" dax_patterns/*.dax | wc -l)
        echo "Total measures found: $total_measures"
        
    - name: Generate summary
      run: |
        echo "### âœ… DAX Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** All DAX formulas validated successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count files
        file_count=$(find dax_patterns -name "*.dax" | wc -l)
        echo "- ðŸ“ Files validated: **$file_count**" >> $GITHUB_STEP_SUMMARY
        
        # Count measures
        measure_count=$(grep -r "^[A-Za-z0-9_][A-Za-z0-9_ %-]* = $" dax_patterns/*.dax | wc -l)
        echo "- ðŸ“Š Total measures: **$measure_count**" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Pattern Categories" >> $GITHUB_STEP_SUMMARY
        echo "| File | Measures |" >> $GITHUB_STEP_SUMMARY
        echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
        
        for file in dax_patterns/*.dax; do
          filename=$(basename "$file")
          count=$(grep "^[A-Za-z0-9_][A-Za-z0-9_ %-]* = $" "$file" | wc -l)
          echo "| $filename | $count |" >> $GITHUB_STEP_SUMMARY
        done
